# 批量回测说明（CSV 驱动）

本目录包含一个批量回测脚本，用于把“手动选择币种/周期/日期时间并分析验证”的流程自动化。

- 脚本文件：[batch_backtest.py](file:///c:/Users/11618/Desktop/refactor_v2(1)(1)(2)/tools/batch_backtest.py)
- 任务列表示例：[backtest_tasks.csv](file:///c:/Users/11618/Desktop/refactor_v2(1)(1)(2)/tools/backtest_tasks.csv)

## 1. 前置条件

- 后端已启动并可访问（默认）：`http://localhost:8000/api/v1`
- 任务 CSV 已准备（见下文格式）

## 2. 运行方式（PowerShell）

在项目根目录执行：

```powershell
python tools\batch_backtest.py --input tools\backtest_tasks.csv
```

常用参数：

```powershell
python tools\batch_backtest.py --input tools\backtest_tasks.csv --concurrency 3
python tools\batch_backtest.py --input tools\backtest_tasks.csv --rerun
python tools\batch_backtest.py --input tools\backtest_tasks.csv --timeout 180 --retries 2 --backoff 1.0
python tools\batch_backtest.py --input tools\backtest_tasks.csv --backend http://localhost:8000/api/v1
```

参数说明：
- `--input`：任务 CSV 路径（必填）
- `--output`：结果 CSV 输出路径（默认 `tools/backtest_results.csv`）
- `--concurrency`：并发数（默认 3）
- `--timeout`：单次请求超时秒（默认 180）
- `--retries`：失败重试次数（默认 2）
- `--backoff`：重试退避基准秒（默认 1.0）
- `--rerun`：不跳过已存在结果，强制重跑
- `--backend`：后端 API 基地址（默认 `http://localhost:8000/api/v1`）

## 3. 任务 CSV 格式（输入）

任务 CSV 至少包含以下列（表头必须存在）：

- `task_id`
- `asset`
- `timeframe`
- `end_date`
- `end_time`

可选列（未填则用默认值）：
- `kline_count`（默认 40）
- `future_kline_count`（默认 13）
- `ai_version`（默认 original）
- `data_method`（默认 to_end）

示例：

```csv
task_id,asset,timeframe,end_date,end_time,kline_count,future_kline_count,ai_version,data_method
1,BTC/USDT,4h,2025-01-24,03:35,40,13,original,to_end
2,ETH/USDT,1h,2025-01-24,03:35,40,13,original,to_end
3,SOL/USDT,15m,2025-01-24,03:35,40,13,original,to_end
```

说明：
- `asset` 支持 `BTC/USDT`、`BTC-USDT`、`BTC` 等（后端会做符号转换）。
- `end_date/end_time` 表示“分析截止时间点”，配合 `data_method=to_end` 使用。

## 4. 结果 CSV 格式（输出）

默认输出到：`tools/backtest_results.csv`

当前输出列为：
- `task_id,asset,timeframe,end_date,end_time`
- `分析时的价格`
- `未来第一根K线的价格`
- `未来第二根K线的价格`
- `ai_decision,is_correct`
- `duration_s,result_id,ai_version,data_method,kline_count,future_kline_count,error`

字段解释：
- `分析时的价格`：分析时刻基准价（作为全部比较的统一基准）
- `未来第一根K线的价格`：格式为 `价格 涨跌幅%`，例如 `3247.400000 +1.34%`
- `未来第二根K线的价格`：格式为 `价格 涨跌幅%`
- `ai_decision`：脚本归一化后的动作，常见为 `LONG/SHORT/HOLD/ERROR`
- `is_correct`：本次任务是否判定为正确（见下文规则）
- `duration_s`：该任务耗时（秒）
- `result_id`：后端生成的分析 ID，可用于查历史
- `error`：失败原因（为空表示成功）

## 5. 正确性判定规则（两根 K 线）

脚本使用“分析时的价格”作为统一基准，取同周期未来第 1、2 根 K 线的收盘价做验证。

仅对 `LONG/SHORT` 做判定（其他动作返回 `Unknown`）：

- 条件一：未来第 1 根和第 2 根方向都与预测一致 => `True`
- 条件二：第 1 根不一致、第 2 根一致，且最终价格相对基准价不亏损 => `True`
- 条件三：第 1 根一致、第 2 根不一致，但最终价格相对基准价不亏损 => `True`

方向与不亏损定义：
- 预测 `LONG`：
  - 方向一致：未来收盘价 `>` 基准价
  - 不亏损：第 2 根收盘价 `>=` 基准价
- 预测 `SHORT`：
  - 方向一致：未来收盘价 `<` 基准价
  - 不亏损：第 2 根收盘价 `<=` 基准价

判定逻辑实现位置：
- [_judge_prediction_two_kline](file:///c:/Users/11618/Desktop/refactor_v2(1)(1)(2)/tools/batch_backtest.py#L107-L150)

## 6. 常见问题

### 6.1 全部报错 Read timed out
- 说明后端请求超时（后端未启动、端口不对、或分析耗时过长）。
- 调大超时：`--timeout 180`
- 降低并发：`--concurrency 1`

### 6.2 No market data found
- 该时间点或该交易对没有返回行情数据（可能 API 不支持、或时间点太早/太未来）。
- 建议换一个 `end_date/end_time` 再试。

### 6.3 输出表头变更
- 脚本检测到输出 CSV 表头变化时，会对现有文件做“原地迁移”（旧行无法补齐的新列会留空）。

